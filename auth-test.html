<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://apis.google.com https://*.gstatic.com https://accounts.google.com https://ssl.gstatic.com https://www.google.com https://*.googleapis.com; frame-src 'self' https://accounts.google.com https://www.google.com https://*.google.com; connect-src 'self' https://accounts.google.com https://*.googleapis.com https://script.google.com https://docs.google.com https://*.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:;">
    <title>AuraReach - Authentication Test</title>
    <link rel="stylesheet" href="dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-envelope-circle-check"></i>
                <span>AuraReach</span>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>
                <a href="gmail-sender.html" class="nav-link">
                    <i class="fas fa-paper-plane"></i>
                    Email Sender
                </a>
                <a href="admin-panel.html" class="nav-link">
                    <i class="fas fa-cog"></i>
                    Admin Panel
                </a>
            </nav>
            <div class="user-menu">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-title">
                    <i class="fas fa-shield-alt"></i>
                    Authentication Test Center
                </div>
                <div class="page-subtitle">
                    Comprehensive testing suite for Google OAuth and system authentication
                </div>
            </div>

            <!-- Test Dashboard -->
            <div class="test-dashboard">
                <!-- System Status Overview -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-heartbeat"></i>
                            System Status
                        </h2>
                        <button class="btn btn-primary" onclick="runFullTest()">
                            <i class="fas fa-play"></i>
                            Run Full Test
                        </button>
                    </div>
                    <div id="statusResult" class="test-result info" style="display: none;"></div>
                </div>
        
                <!-- Test Sections Grid -->
                <div class="test-grid">
                    <!-- Configuration Test -->
                    <div class="test-card">
                        <div class="test-card-header">
                            <div class="test-card-title">
                                <i class="fas fa-cogs"></i>
                                Configuration Test
                            </div>
                            <div class="test-card-description">
                                Verify system configuration and environment settings
                            </div>
                        </div>
                        <div class="test-card-actions">
                            <button class="btn btn-primary" onclick="testConfiguration()">
                                <i class="fas fa-check-circle"></i>
                                Test Configuration
                            </button>
                        </div>
                        <div id="configResult" class="test-result info" style="display: none;"></div>
                    </div>

                    <!-- Google OAuth Test -->
                    <div class="test-card">
                        <div class="test-card-header">
                            <div class="test-card-title">
                                <i class="fab fa-google"></i>
                                Google OAuth Test
                            </div>
                            <div class="test-card-description">
                                Test Google authentication and user sign-in flow
                            </div>
                        </div>
                        <div class="test-card-actions">
                            <button class="btn btn-primary" onclick="testGoogleAuth()">
                                <i class="fas fa-key"></i>
                                Initialize Auth
                            </button>
                            <button class="btn btn-outline" onclick="signInTest()">
                                <i class="fas fa-sign-in-alt"></i>
                                Sign In
                            </button>
                            <button class="btn btn-outline" onclick="signOutTest()">
                                <i class="fas fa-sign-out-alt"></i>
                                Sign Out
                            </button>
                        </div>
                        <div id="authResult" class="test-result info" style="display: none;"></div>
                        
                        <div id="userInfo" class="user-info-card" style="display: none;">
                            <div class="user-info-header">
                                <i class="fas fa-user-check"></i>
                                Authenticated User
                            </div>
                            <div class="user-details">
                                <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                                <div class="user-data">
                                    <div class="user-field">
                                        <span class="field-label">Name:</span>
                                        <span id="userName" class="field-value"></span>
                                    </div>
                                    <div class="user-field">
                                        <span class="field-label">Email:</span>
                                        <span id="userEmail" class="field-value"></span>
                                    </div>
                                    <div class="user-field">
                                        <span class="field-label">Role:</span>
                                        <span id="userRole" class="field-value"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Apps Script Test -->
                    <div class="test-card">
                        <div class="test-card-header">
                            <div class="test-card-title">
                                <i class="fas fa-code"></i>
                                Apps Script Connection
                            </div>
                            <div class="test-card-description">
                                Test Google Apps Script and database connectivity
                            </div>
                        </div>
                        <div class="test-card-actions">
                            <button class="btn btn-primary" onclick="testAppsScript()">
                                <i class="fas fa-link"></i>
                                Test Apps Script
                            </button>
                            <button class="btn btn-outline" onclick="testDatabaseConnection()">
                                <i class="fas fa-database"></i>
                                Test Database
                            </button>
                        </div>
                        <div id="scriptResult" class="test-result info" style="display: none;"></div>
                    </div>

                    <!-- User Management Test -->
                    <div class="test-card">
                        <div class="test-card-header">
                            <div class="test-card-title">
                                <i class="fas fa-users-cog"></i>
                                User Management
                            </div>
                            <div class="test-card-description">
                                Test user limits, permissions, and access controls
                            </div>
                        </div>
                        <div class="test-card-actions">
                            <button class="btn btn-primary" onclick="testUserLimits()">
                                <i class="fas fa-chart-line"></i>
                                Test User Limits
                            </button>
                            <button class="btn btn-outline" onclick="testPermissions()">
                                <i class="fas fa-shield-check"></i>
                                Test Permissions
                            </button>
                        </div>
                        <div id="userResult" class="test-result info" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Include authentication scripts -->
    <script src="auth-config.js"></script>
    
    <style>
        /* Test Grid Layout */
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        /* Test Cards */
        .test-card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .test-card-header {
            margin-bottom: 1.5rem;
        }

        .test-card-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .test-card-title i {
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .test-card-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .test-card-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        /* User Info Card */
        .user-info-card {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .user-info-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .user-info-header i {
            color: var(--success-color);
        }

        .user-details {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
        }

        .user-data {
            flex: 1;
        }

        .user-field {
            display: flex;
            margin-bottom: 0.5rem;
        }

        .field-label {
            font-weight: 500;
            color: var(--text-secondary);
            min-width: 60px;
        }

        .field-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Test Results */
        .test-result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.4;
            animation: fadeIn 0.3s ease;
        }

        .test-result.success {
            background: var(--success-bg);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .test-result.error {
            background: var(--error-bg);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .test-result.info {
            background: var(--info-bg);
            color: var(--info-color);
            border: 1px solid var(--info-color);
        }

        /* Button Loading State */
        .btn.loading {
            position: relative;
            color: transparent;
            pointer-events: none;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .test-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .test-card-actions {
                flex-direction: column;
            }

            .test-card-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .user-details {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    
    <script>
        // Use the global authManager from auth-config.js
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            showResult('configResult', 'info', 'Page loaded. Ready for testing.');
            
            // Add ripple effect to buttons
            document.querySelectorAll('.btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.classList.add('ripple');
                    
                    this.appendChild(ripple);
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });
        });
        
        function addButtonLoading(buttonElement) {
            buttonElement.classList.add('loading');
            buttonElement.disabled = true;
        }

        function removeButtonLoading(buttonElement) {
            buttonElement.classList.remove('loading');
            buttonElement.disabled = false;
        }
        
        // Test configuration
        function testConfiguration() {
            const button = event.target;
            addButtonLoading(button);
            showResult('configResult', 'info', 'Testing configuration...');
            
            setTimeout(() => {
                try {
                    const config = {
                        'Excel Sheet ID': AUTH_CONFIG.EXCEL_SHEET_ID || 'Not configured',
                        'Google OAuth Client ID': AUTH_CONFIG.GOOGLE_OAUTH_CLIENT_ID || 'Not configured',
                        'Apps Script URL': AUTH_CONFIG.APPS_SCRIPT_URL || 'Not configured',
                        'Auto Login': AUTH_CONFIG.AUTO_LOGIN ? 'Enabled' : 'Disabled',
                        'Session Timeout': AUTH_CONFIG.SESSION_TIMEOUT_MINUTES + ' minutes'
                    };
                    
                    let result = '<strong>Configuration Status:</strong><br>';
                    for (const [key, value] of Object.entries(config)) {
                        const status = value !== 'Not configured' ? '✅' : '❌';
                        result += `${status} ${key}: <span class="field-value">${value}</span><br>`;
                    }
                    
                    showResult('configResult', 'success', result);
                } catch (error) {
                    showResult('configResult', 'error', 'Configuration test failed: ' + error.message);
                }
                removeButtonLoading(button);
            }, 1000);
        }
        
        // Test Google Auth initialization
        async function testGoogleAuth() {
            const button = event.target;
            addButtonLoading(button);
            showResult('authResult', 'info', 'Testing Google Authentication...');
            
            try {
                if (typeof window.authManager === 'undefined') {
                    throw new Error('AuthManager not found. Check auth-config.js');
                }
                
                await window.authManager.init();
                
                showResult('authResult', 'success', '✅ Google Auth initialized successfully');
            } catch (error) {
                showResult('authResult', 'error', '❌ Google Auth initialization failed: ' + error.message);
            }
            removeButtonLoading(button);
        }
        
        // Test sign in
        async function signInTest() {
            const button = event.target;
            addButtonLoading(button);
            showResult('authResult', 'info', 'Testing sign in...');
            
            try {
                if (!window.authManager) {
                    await testGoogleAuth();
                }
                
                const result = await window.authManager.signIn();
                
                if (result.success) {
                    showResult('authResult', 'success', '✅ Sign in successful');
                    displayUserInfo(result.user);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showResult('authResult', 'error', '❌ Sign in failed: ' + error.message);
            }
            removeButtonLoading(button);
        }
        
        // Test sign out
        async function signOutTest() {
            const button = event.target;
            addButtonLoading(button);
            showResult('authResult', 'info', 'Testing sign out...');
            
            try {
                if (!window.authManager) {
                    throw new Error('AuthManager not initialized');
                }
                
                await window.authManager.signOut();
                showResult('authResult', 'success', '✅ Sign out successful');
                hideUserInfo();
            } catch (error) {
                showResult('authResult', 'error', '❌ Sign out failed: ' + error.message);
            }
            removeButtonLoading(button);
        }
        
        // Test Apps Script connection
        async function testAppsScript() {
            const button = event.target;
            addButtonLoading(button);
            showResult('scriptResult', 'info', 'Testing Apps Script connection...');
            
            try {
                const scriptUrl = AUTH_CONFIG.APPS_SCRIPT_URL;
                if (!scriptUrl) {
                    throw new Error('Apps Script URL not configured');
                }
                
                const response = await fetch(scriptUrl + '?test=true');
                const result = await response.text();
                
                showResult('scriptResult', 'success', '✅ Apps Script connection successful<br><small>Response: ' + result + '</small>');
            } catch (error) {
                showResult('scriptResult', 'error', '❌ Apps Script connection failed: ' + error.message);
            }
            removeButtonLoading(button);
        }
        
        // Test database connection
        async function testDatabaseConnection() {
            const button = event.target;
            addButtonLoading(button);
            showResult('scriptResult', 'info', 'Testing database connection...');
            
            try {
                if (!window.authManager) {
                    throw new Error('AuthManager not initialized');
                }
                
                const result = await window.authManager.testDatabaseConnection();
                
                if (result.success) {
                    showResult('scriptResult', 'success', '✅ Database connection successful');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showResult('scriptResult', 'error', '❌ Database connection failed: ' + error.message);
            }
            removeButtonLoading(button);
        }
        
        // Test user limits
        async function testUserLimits() {
            const button = event.target;
            addButtonLoading(button);
            showResult('userResult', 'info', 'Testing user limits...');
            
            try {
                if (!window.authManager || !window.authManager.isAuthenticated) {
                    throw new Error('User not authenticated');
                }
                
                const limits = await window.authManager.getUserLimits();
                let result = '<strong>User Limits:</strong><br>';
                for (const [key, value] of Object.entries(limits)) {
                    result += `${key}: <span class="field-value">${value}</span><br>`;
                }
                showResult('userResult', 'success', result);
            } catch (error) {
                showResult('userResult', 'error', '❌ User limits test failed: ' + error.message);
            }
            removeButtonLoading(button);
        }
        
        // Test permissions
        async function testPermissions() {
            const button = event.target;
            addButtonLoading(button);
            showResult('userResult', 'info', 'Testing user permissions...');
            
            try {
                if (!window.authManager || !window.authManager.isAuthenticated) {
                    throw new Error('User not authenticated');
                }
                
                const permissions = {
                    'Can Send Email': await window.authManager.checkPermission('send_email'),
                    'Can Manage Users': await window.authManager.checkPermission('manage_users'),
                    'Can View Analytics': await window.authManager.checkPermission('view_analytics'),
                    'Can Export Data': await window.authManager.checkPermission('export_data')
                };
                
                let result = '<strong>User Permissions:</strong><br>';
                for (const [perm, allowed] of Object.entries(permissions)) {
                    result += `${allowed ? '✅' : '❌'} ${perm}<br>`;
                }
                
                showResult('userResult', 'success', result);
            } catch (error) {
                showResult('userResult', 'error', '❌ Permissions test failed: ' + error.message);
            }
            removeButtonLoading(button);
        }
        
        // Run full system test
        async function runFullTest() {
            const button = event.target;
            addButtonLoading(button);
            showResult('statusResult', 'info', 'Running full system test...');
            
            const tests = [
                { name: 'Configuration', fn: testConfiguration },
                { name: 'Google Auth Init', fn: testGoogleAuth },
                { name: 'Apps Script', fn: testAppsScript }
            ];
            
            const results = [];
            
            for (const test of tests) {
                try {
                    await test.fn();
                    results.push(`✅ ${test.name}: PASSED`);
                } catch (error) {
                    results.push(`❌ ${test.name}: FAILED - ${error.message}`);
                }
            }
            
            let result = '<strong>Full System Test Results:</strong><br>' + results.join('<br>');
            showResult('statusResult', 'info', result);
            removeButtonLoading(button);
        }
        
        // Display user info
        function displayUserInfo(user) {
            document.getElementById('userAvatar').src = user.picture || '';
            document.getElementById('userName').textContent = user.name || 'N/A';
            document.getElementById('userEmail').textContent = user.email || 'N/A';
            document.getElementById('userRole').textContent = user.role || 'user';
            document.getElementById('userInfo').style.display = 'block';
        }
        
        // Hide user info
        function hideUserInfo() {
            document.getElementById('userInfo').style.display = 'none';
        }
        
        // Show result
        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `test-result ${type}`;
            element.innerHTML = message;
            element.style.display = 'block';
        }
    </script>
</body>
</html>